import discord
import os
import re
import threading
from flask import Flask, jsonify, render_template
from datetime import datetime, timezone, timedelta

# -------------------------------------
# 설정
# -------------------------------------
DISCORD_TOKEN = os.environ.get('DISCORD_TOKEN')
TARGET_CHANNEL_ID = int(os.environ.get('TARGET_CHANNEL_ID'))

# ★★★ 사용자님이 제공해주신 정확하고 완전한 UUID 목록으로 교체 ★★★
UUID_MAP = {
    "B6254D56-1931-8E9A-6F2C-C413BCA4F6CB": "1번 컴퓨터", "00F54D56-3471-F7DA-19A0-25962FD3EDD4": "2번 컴퓨터",
    "698A4D56-6628-2370-1786-F01F6FB8E011": "3번 컴퓨터", "758B4D56-184F-DCCE-BA13-5125C618E676": "4번 컴퓨터",
    "DF1F4D56-5DC5-8F54-464D-64A208A271FA": "5번 컴퓨터", "C6144D56-3194-835A-DBC7-220B047B5C38": "6번 컴퓨터",
    "AD164D56-9697-F145-06F9-234427A81542": "7번 컴퓨터", "D65F4D56-1EF8-F9E0-4D09-5EAB7DD1FF23": "8번 컴퓨터",
    "8F3D4D56-F7B9-2BF2-9759-BC51850C4FB5": "9번 컴퓨터", "38604D56-CA2C-9EAB-EE8C-A5027CA9DF1F": "10번 컴퓨터",
    "38D04D56-D069-560A-C0F2-8134C084F51A": "11번 컴퓨터", "3ECC4D56-5665-E689-A421-6A75E2798EA9": "12번 컴퓨터",
    "F4744D56-1E66-CFDC-E512-A24802575046": "13번 컴퓨터", "F26D4D56-3C10-BB01-0A3F-986608EFF8EB": "14번 컴퓨터",
    "EF554D56-02FA-6B27-D7DF-E0035735F46F": "15번 컴퓨터", "40F54D56-F32B-5907-EAB9-ECDE4575790F": "16번 컴퓨터",
    "4AE64D56-A83F-5E42-ECBC-013ED8481177": "17번 컴퓨터", "F9624D56-FC82-5E28-9B63-4E7E2A7974EE": "18번 컴퓨터",
    "1E234D56-F6D0-505D-D45A-4C50C5927269": "19번 컴퓨터", "04E44D56-E467-0627-2F09-BF4A717066CD": "20번 컴퓨터",
    "FFEA4D56-A459-CAA5-9533-AA1E22B6DA5D": "21번 컴퓨터", "26C94D56-5A33-763F-9A0B-5F4CDDDDC7EC": "22번 컴퓨터",
    "17104D56-DDFE-8D21-449B-C33B19A927F3": "23번 컴퓨터", "D6A84D56-8450-D574-938C-ED8C16A77DD4": "24번 컴퓨터",
    "949E4D56-09CB-B9CE-DBEC-D0FC68A4BC75": "25번 컴퓨터", "D1D64D56-F555-9DCA-3925-4DD0B1A3712E": "26번 컴퓨터",
    "CFA94D56-676A-E605-ECF2-112CDEA03B97": "27번 컴퓨터", "78B64D56-D806-067C-D546-7FABCEA4A3A4": "28번 컴퓨터",
    "7F0F4D56-9C6F-997F-9A6A-161C339ADA9A": "29번 컴퓨터", "31FF4D56-3181-17BD-7809-74B11C1876F9": "30번 컴퓨터",
    "8E544D56-FF26-B51A-6EA4-F3B0F3C1ED3F": "31번 컴퓨터", "136D4D56-75C7-3E35-3265-82E06F38590B": "32번 컴퓨터",
    "FB4B4D56-BCAD-A688-3BBB-3852183AF890": "33번 컴퓨터", "8DA94D56-ED63-A920-9271-F07D95ADC724": "34번 컴퓨터",
    "D8F84D56-7C5C-DD5A-B83F-FF721A44631D": "35번 컴퓨터", "89084D56-8154-DD3A-7309-730605E29ADE": "36번 컴퓨터",
    "CB814D56-26FA-C719-88A3-5A9352ADDD18": "37번 컴퓨터", "EEE74D56-EC3D-519E-65D5-0542F2943FB7": "38번 컴퓨터",
    "C1624D56-4416-42C0-A00F-921FC1561D91": "39번 컴퓨터", "DCF64D56-B2D6-A192-600D-13663D8FE5F2": "40번 컴퓨터",
    "4B9F4D56-5555-A0F4-1A02-ECB5D4963487": "41번 컴퓨터", "F2CC4D56-3B73-EC7F-CF91-B61E41F68992": "42번 컴퓨터",
    "E0624D56-2283-3A43-B01B-A76432FDE910": "43번 컴퓨터", "57D84D56-5D42-A290-2247-47AAEEC47A0C": "44번 컴퓨터",
    "DA884D56-501E-D0B7-690B-08F44F8C61A6": "45번 컴퓨터", "598C4D56-5329-B19C-E606-DC4A20304702": "46번 컴퓨터",
    "D8224D56-6ECE-AE1D-7CB1-86DFF778B508": "47번 컴퓨터", "9CC74D56-C15B-DE2D-79C7-68F0E23E927E": "48번 컴퓨터",
    "F05B4D56-C2A1-0826-BD7A-777EAC987CEA": "49번 컴퓨터", "0A974D56-C2BF-965B-F9BF-0AA60716C96B": "50번 컴퓨터",
    "11424D56-8BBF-E8F0-6AA0-BA1B6738A31B": "51번 컴퓨터", "EE554D56-917C-9C06-A515-27DE7FB7DAB1": "52번 컴퓨터",
    "28354D56-1929-2BE0-78DC-02847872655B": "53번 컴퓨터", "CC224D56-33E6-AC79-75BF-0FFD85410C16": "54번 컴퓨터",
    "14F64D56-34C5-F375-4F34-0EEA9DB51071": "55번 컴퓨터", "DCDA4D56-5A60-964F-F5F9-C513CE621170": "56번 컴퓨터",
    "E2854D56-CDF8-0C32-4A80-A3CAC58AA299": "57번 컴퓨터", "392A4D56-EF74-8BFF-11EE-1A5FC500AFD6": "58번 컴퓨터",
    "96FC4D56-48D0-2955-0555-FE6A61B9016B": "59번 컴퓨터", "2E5A4D56-B89E-0014-B656-B2528E1D70C6": "60번 컴퓨터",
    "DA584D56-5A32-52F2-65CC-C345DB5C4CFB": "61번 컴퓨터", "E0E54D56-BE7F-1DBE-C1AF-4ACE647D9AE0": "62번 컴퓨터",
    "35394D56-343C-ED35-014C-4BA8EAA722AF": "63번 컴퓨터", "50854D56-54EF-07F7-8A14-C0D785D598B5": "64번 컴퓨터",
    "96F14D56-6656-09EB-5085-D14C8C079FC9": "65번 컴퓨터", "FAEF4D56-25A8-B818-DDE3-CC1C5827652F": "66번 컴퓨터",
    "4DA34D56-5BAA-A3CC-CAE4-B6B126B19AE6": "67번 컴퓨터", "E5EB4D56-9167-FDC0-409D-E2792CF0A29B": "68번 컴퓨터",
    "0DBC4D56-9317-6718-09A3-3A63E34B680F": "69번 컴퓨터", "0F094D56-484E-238E-6A15-4A99D36C75D7": "70번 컴퓨터",
    "912E4D56-7B3C-40F0-6541-2DD718087BC4": "71번 컴퓨터", "F4D54D56-3C16-D7A7-E422-11A9CFB0481A": "72번 컴퓨터",
    "F5C84D56-0DEE-ABDD-4031-2A439FED1EE4": "73번 컴퓨터", "C24C4D56-F9AA-9383-D6C3-5256911D02AA": "74번 컴퓨터",
    "7D684D56-4630-B174-0C6A-0A5F6EA809E7": "75번 컴퓨터", "5D0C4D56-D01B-6EC6-C249-C2564FA84AF4": "76번 컴퓨터",
    "98C84D56-C7E9-4364-3E7B-5832C15EC7F0": "77번 컴퓨터", "58984D56-52FF-A1A5-73C9-CFB0C5FE7CA0": "78번 컴퓨터",
    "DBED4D56-44E3-9727-1732-C13774844C3E": "79번 컴퓨터", "08164D56-3B84-49A3-1F23-4381CCBCE138": "80번 컴퓨터",
    "5EE74D56-22DA-98AC-951E-38AA6309EEC6": "81번 컴퓨터", "84A64D56-9DB8-02A0-9C1B-1C0F52E2D3C3": "82번 컴퓨터",
    "CF514D56-65A8-EC7C-0429-FE0F45E5D46B": "83번 컴퓨터", "8A324D56-0FFF-90AD-EFFB-EF46F16F362C": "84번 컴퓨터",
    "AA7A4D56-A640-1163-432F-C253191D61FC": "85번 컴퓨터", "85014D56-1060-C870-9C86-C7FC58DE1EF2": "86번 컴퓨터",
    "A7F84D56-558E-A3BE-0E91-8CFBF567C683": "87번 컴퓨터", "83FD4D56-590C-ED0B-3EF9-02AEBD5B6C53": "88번 컴퓨터",
    "CA4A4D56-46C1-C3AD-255C-3CAB38FB26DA": "89번 컴퓨터", "B87D4D56-6800-C635-9ECC-959008CE1E02": "90번 컴퓨터",
    "11154D56-A0DC-C075-3EC6-002B8DEB7F55": "91번 컴퓨터", "57C44D56-A72A-1784-D3F8-E06F36E8BDD8": "92번 컴퓨터",
    "5A594D56-0766-85D6-D681-537FD9403362": "93번 컴퓨터", "FE584D56-11E8-0444-EF92-8206889A90A4": "94번 컴퓨터",
    "47E64D56-A18F-58E2-FF3A-2B628388C042": "95번 컴퓨터", "20E54D56-0FF1-7931-20A3-18DA6FA47F62": "96번 컴퓨터",
    "9DEB4D56-B34C-A6DC-005A-DCE0CC11399C": "97번 컴퓨터", "91AF4D56-941F-9F67-C96C-6F81E34DB77F": "98번 컴퓨터",
    "1B154D56-A849-FF1F-259B-E93EC86F026F": "99번 컴퓨터", "DE074D56-6E1D-A462-74F7-392D84D7BD40": "100번 컴퓨터",
    "33614D56-0562-3C27-6C29-BBA169C61E79": "101번 컴퓨터", "61314D56-9138-7D59-E5EB-6B34BB5ADAC4": "102번 컴퓨터",
    "264F4D56-DC79-9530-FFA1-C2FF703C8665": "103번 컴퓨터", "FDB34D56-0CA9-ECF3-6252-C7C0E5766EB4": "104번 컴퓨터",
    "37744D56-1ED4-CFBC-BEC6-EC49DE5A5447": "105번 컴퓨터", "81C94D56-F254-F589-AAAB-287805BB9B94": "106번 컴퓨터",
    "5CEF4D56-08D4-DB10-752D-336D09BDAEB4": "107번 컴퓨터", "52204D56-0FCC-C966-5252-9ED04235D92B": "108번 컴퓨터",
    "8B144D56-A5CA-B5D4-DEAB-C31BD1F131AB": "109번 컴퓨터", "9E7A4D56-E0C9-230E-A9E6-0E8876AC3EAB": "110번 컴퓨터",
    "730D4D56-9996-F446-7FC2-C5854DD34D11": "111번 컴퓨터", "1A524D56-2291-7B6D-C5A2-D75394C1E37F": "112번 컴퓨터",
    "82734D56-47C4-A24F-F615-D88B623038FC": "113번 컴퓨터", "AEC54D56-BA4B-D930-C810-93B46F69C5DE": "114번 컴퓨터",
    "4DDF4D56-447E-F9B0-F826-92827F5D336C": "115번 컴퓨터", "F0A04D56-049A-A488-2742-467BCFD12DF9": "116번 컴퓨터",
    "E2764D56-A60B-9477-BA26-E86837CC727D": "117번 컴퓨터", "D7504D56-CF94-4635-0EC2-61415CAE9C19": "118번 컴퓨터",
    "F8564D56-7806-BE95-EC40-DBB69C4F212C": "119번 컴퓨터", "54D24D56-0A13-638C-FC59-9D3A817A5604": "120번 컴퓨터",
    "DCA24D56-3F04-F663-F576-78E4B357FF2E": "121번 컴퓨터", "4F594D56-1FBF-AD86-6039-0617730E024B": "122번 컴퓨터",
    "DAA14D56-8444-5DFB-970E-80139DB8403E": "123번 컴퓨터", "77494D56-7357-A700-7CE7-5195CC4F5BDD": "124번 컴퓨터",
    "A65D4D56-7407-2640-8A06-4720ED0CB082": "125번 컴퓨터", "50264D56-D27F-029F-E6AD-1B7A192156BD": "126번 컴퓨터",
    "F4D84D56-43E8-6EE2-CBD5-F7B77C9221F1": "127번 컴퓨터", "FA9E4D56-3FA6-AF19-F786-5923C38940C7": "128번 컴퓨터",
    "8DBB4D56-EEE5-8E9E-4F6B-5FA4DCD4BF32": "129번 컴퓨터", "52DA4D56-2709-7027-1563-D80961D98AED": "130번 컴퓨터",
    "70584D56-6C92-1AEF-92DD-8CFDCE10136B": "131번 컴퓨터", "66C44D56-F270-6BBE-4970-FA81030F6530": "132번 컴퓨터",
    "0DC44D56-94CF-86DD-5F46-D9A52C32B5C0": "133번 컴퓨터", "8C494D56-5F01-C75F-045D-256ABDC3F8B5": "134번 컴퓨터",
    "22D84D56-AE24-5D0D-9BCD-2559D315107E": "135번 컴퓨터", "90434D56-0815-C01A-A376-A51BA157DBD1": "136번 컴퓨터",
    "13A64D56-F535-450B-8720-BA283EBCCC34": "137번 컴퓨터", "82274D56-5D26-8952-3DE8-F63BD44B39C1": "138번 컴퓨터",
    "6E6C4D56-A7DF-F985-28FC-EDAD429B9E8F": "139번 컴퓨터", "0AAA4D56-0F9B-159D-E414-688065AB11F6": "140번 컴퓨터",
    "7FA34D56-9263-30F6-1C7E-5198E7E86F4E": "141번 컴퓨터", "B67F4D56-D6F0-9840-FC50-310659CD0A4B": "142번 컴퓨터",
    "536A4D56-A40E-1AC9-638F-C3FD34FB2780": "143번 컴퓨터", "D5E44D56-43D1-1BB8-B612-F6660660410B": "144번 컴퓨터",
    "5DE74D56-F466-74C2-654E-0157AD28242E": "145번 컴퓨터", "13514D56-ADC0-8A01-0403-02FF2CD34390": "146번 컴퓨터",
    "EE5A4D56-C18C-EE35-3CD9-B0317BAAE32B": "147번 컴퓨터", "F7C94D56-229D-B91B-CA5A-D26682D2E8F4": "148번 컴퓨터",
    "9DEB4D56-CF4C-0562-62B9-28DAD50C1ED5": "149번 컴퓨터", "FC8F4D56-DBC8-9879-80C2-58BFD8E8D620": "150번 컴퓨터",
    "4DEB4D56-F2AB-001E-5CB1-EB00EF30AE65": "151번 컴퓨터", "F5A84D56-D091-19D7-A82A-9CCF8838869A": "152번 컴퓨터",
    "F7BB4D56-54B0-8B09-60D2-10EFF5C8C70B": "153번 컴퓨터", "70844D56-F7B9-F7D1-3161-2867F5D4A1FA": "154번 컴퓨터",
    "B4024D56-3E43-791B-D5EC-BDF3B3437AB1": "155번 컴퓨터", "44B64D56-FEA6-50AE-F4F2-FC1578D032C7": "156번 컴퓨터",
    "3DD74D56-851D-62A9-66DC-8CDBFA63A48B": "181번 컴퓨터", "F1794D56-D9A5-771C-F58E-1DFEB8060DE0": "182번 컴퓨터",
    "74D54D56-E7BF-019E-161A-3DD403BF3E00": "183번 컴퓨터", "E5D74D56-0B34-75C4-3D71-A42DF9317DA4": "184번 컴퓨터",
    "15584D56-4824-AE41-64F3-42BC5DE9AE97": "185번 컴퓨터", "3C4A4D56-D110-8D0D-3477-D05E075B0006": "186번 컴퓨터",
    "D2CB4D56-5C01-E05C-60B2-508D17B6052C": "187번 컴퓨터", "8EC24D56-4576-9A61-6CD0-1E10DC9313E5": "188번 컴퓨터",
    "78BF4D56-03DB-782E-9C9E-291F78094CB7": "189번 컴퓨터", "BE8E4D56-6A64-ED18-5246-D8F58E3D2DB7": "190번 컴퓨터",
    "6AD34D56-B5BE-AE6F-C257-0890C8502B3C": "191번 컴퓨터", "34EC4D56-9C18-EDF5-2FDB-76A9F76CE70A": "192번 컴퓨터",
    "4FDB4D56-3628-B8F5-C6B1-A04043C27381": "193번 컴퓨터", "A0944D56-AC16-2BA1-06E8-E0DDCF160748": "194번 컴퓨터",
    "B9A04D56-B062-12AE-6DEA-54638A3A618C": "195번 컴퓨터", "A9504D56-0E97-CF35-29B7-84EF9A48483B": "196번 컴퓨터",
    "09484D56-0250-F63F-F371-C792B084509B": "197번 컴퓨터", "D68F4D56-E5FA-71BF-A3D0-B030A6A99E4E": "198번 컴퓨터",
    "0A0E4D56-855D-108F-BD73-0CF7E138A028": "199번 컴퓨터", "9AE74D56-0F0B-8A72-5BA6-DFAD7F7256EB": "200번 컴퓨터",
    "43B14D56-CAC6-F0C7-B2B3-D786718F10E1": "201번 컴퓨터", "5E1C4D56-10D1-248E-96BD-D3911E0C5270": "202번 컴퓨터",
    "70F74D56-D493-C7A5-1A0D-5419CB4BDB57": "203번 컴퓨터", "AC934D56-6B30-7895-1978-1EF162201A11": "204번 컴퓨터",
    "B07A4D56-E9C0-BDC4-571D-03C75300FFC5": "205번 컴퓨터", "5D8A4D56-7005-BEA5-5AF9-D21946AF0129": "206번 컴퓨터",
    "01304D56-97EF-877C-42FC-165F49489011": "207번 컴퓨터", "18BF4D56-ED3F-0CF7-7526-07D92A5D3598": "208번 컴퓨터",
    "65C04D56-F6CE-1C53-D65D-53D7BDA38A83": "209번 컴퓨터", "53E04D56-6882-E72F-1C86-71960E530B50": "210번 컴퓨터",
    "FFA74D56-E423-A4D8-2D22-131772B484D3": "211번 컴퓨터", "E1804D56-D252-8F58-9029-AA464C946387": "212번 컴퓨터",
    "242C4D56-18C0-D810-EA9F-028D8E067478": "213번 컴퓨터", "E5EF4D56-DF55-C87F-3F7E-4C75A34DBDDC": "214번 컴퓨터",
    "90F94D56-28DF-0947-BD2C-2A0A2917AF57": "215번 컴퓨터", "267A4D56-BB8C-D558-413D-D8C2CBD6A132": "216번 컴퓨터",
    "25AC4D56-DBD5-7697-7641-32B3DB743001": "217번 컴퓨터", "56FD4D56-725D-C6F5-01DA-3BCFB841954B": "218번 컴퓨터",
    "32784D56-D25E-B3BE-89B1-BBA0835606D6": "219번 컴퓨터", "114F4D56-5EED-5C06-D988-F257587178A3": "220번 컴퓨터",
    "7BB04D56-ACD0-241B-C395-09185C8F9B6D": "221번 컴퓨터", "722A4D56-C3BE-9938-3C64-6BFE43D1A540": "222번 컴퓨터",
    "468A4D56-B9B5-DDE1-8CB2-AC35CE57AC04": "223번 컴퓨터", "D59A4D56-847E-7F9A-D8A9-899C59140A02": "224번 컴퓨터",
    "73954D56-EA85-F704-E1D9-8F6E1CA04CE2": "225번 컴퓨터", "AEC64D56-90ED-7D97-D10C-16A9FB897CDA": "226번 컴퓨터",
    "66B84D56-6F31-C15D-1EC5-6C45BD58B53C": "227번 컴퓨터", "33044D56-4BAE-F340-46FA-16642EF8A1EB": "228번 컴퓨터",
    "8DC74D56-BE45-D65C-D4BC-F76E1E021688": "229번 컴퓨터", "C5604D56-6C4B-D18E-2BD8-556013C746C3": "230번 컴퓨터",
    "2D6B4D56-FC68-6195-DE9C-6AD2B629B59E": "231번 컴퓨터", "88A34D56-E812-9F18-BA46-8F59CE4CF59C": "232번 컴퓨터",
    "34244D56-96BB-55F6-CEA1-D75FACC7E729": "233번 컴퓨터", "AB344D56-9A1F-005A-2DCD-A9CFD5DEE67B": "234번 컴퓨터",
    "6F544D56-2B92-1F01-86F4-AC02B3A075E5": "239번 컴퓨터",
    "": "UUID 없음" # UUID가 비어있는 경우
}

computer_statuses = {}
status_lock = threading.Lock()
app = Flask(__name__)

def initialize_statuses():
    for name in UUID_MAP.values():
        if name not in computer_statuses:
            computer_statuses[name] = { 'status': '알 수 없음', 'log_timestamp': '-', 'last_update': datetime.now(timezone(timedelta(hours=9))).isoformat() }
    
    empty_uuid_numbers = [157, 158, 159, 160, 161, 162, 163, 164, 165, 166, 167, 168, 169, 170, 171, 172, 173, 174, 175, 176, 177, 178, 179, 180, 235, 236, 237, 238, 240]
    for num in empty_uuid_numbers:
        name = f"{num}번 컴퓨터"
        computer_statuses[name] = { 'status': 'UUID 없음', 'log_timestamp': '-', 'last_update': datetime.now(timezone(timedelta(hours=9))).isoformat() }

intents = discord.Intents.default()
intents.message_content = True
client = discord.Client(intents=intents)

UUID_PATTERN = re.compile(r'([0-9A-F]{8}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{12})', re.IGNORECASE)
LOG_TIMESTAMP_PATTERN = re.compile(r'\[(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})\]')

def parse_and_update_status(message_content):
    uuid_match = UUID_PATTERN.search(message_content)
    uuid = uuid_match.group(1).upper() if uuid_match else ""
    display_name = UUID_MAP.get(uuid, uuid) if uuid else UUID_MAP.get("")

    status = None
    timestamp_match = LOG_TIMESTAMP_PATTERN.search(message_content)
    log_timestamp = timestamp_match.group(1) if timestamp_match else "N/A"

    if "__시작" in message_content: status = "시작"
    elif "__종료" in message_content: status = "종료"
    
    if status and display_name:
        kst = timezone(timedelta(hours=9))
        server_check_time = datetime.now(kst).isoformat()
        with status_lock:
            computer_statuses[display_name] = {
                'status': status,
                'log_timestamp': log_t
